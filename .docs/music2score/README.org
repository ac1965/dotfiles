#+title: ğŸ¶ Audio2Score â€” éŸ³æºã‹ã‚‰MIDIã¨è­œé¢ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
#+author: YAMASHITA, Takao
#+language: ja
#+property: header-args :comments link :mkdirp yes
#+startup: show2levels indent

* âœ¨ æ¦‚è¦
ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¯ã€éŸ³æºãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆWAV/MP3/AIFC ãªã©ï¼‰ã‹ã‚‰  
**ã‚¹ãƒ†ãƒ åˆ†é›¢ â†’ æ¥½å™¨MIDIåŒ– â†’ æ­Œè©æŠ½å‡º â†’ è­œé¢åŒ–(MusicXML)** ã¾ã§ã‚’è‡ªå‹•ã§å®Ÿè¡Œã™ã‚‹ macOS / Linux å‘ã‘ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã§ã™ã€‚

*ä¸»ãªæ§‹æˆè¦ç´ *
- ğŸ› UVR5ï¼šãƒœãƒ¼ã‚«ãƒ«ã¨æ¥½å™¨ã‚’ã‚¹ãƒ†ãƒ åˆ†é›¢
- ğŸ§  NeuralNoteï¼šæ¥½å™¨ãƒ‘ãƒ¼ãƒˆã‚’ Audioâ†’MIDIï¼ˆGUIã§ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ï¼‰
- âš™ï¸ *process.sh*ï¼šãƒœãƒ¼ã‚«ãƒ«ã‚’ *MIDI + æ­Œè©(SRT) + MusicXML* ã«è‡ªå‹•å¤‰æ›
- ğŸ¼ MuseScoreï¼šæ­Œè©ã¤ãè­œé¢ï¼ˆMusicXMLï¼‰ã®ç¢ºèªãƒ»ç·¨é›†

* ğŸ”— ãƒ„ãƒ¼ãƒ«æ¦‚è¦ã¨URL
- ğŸ§  *NeuralNote*ï¼šDAWã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³/ã‚¹ã‚¿ãƒ³ãƒ‰ã‚¢ãƒ­ãƒ³ã¨ã—ã¦å‹•ä½œã™ã‚‹ Audioâ†’MIDI å¤‰æ›ãƒ„ãƒ¼ãƒ«ã€‚  
  ãƒãƒªãƒ•ã‚©ãƒ‹ãƒƒã‚¯å¯¾å¿œãƒ»ãƒ”ãƒƒãƒãƒ™ãƒ³ãƒ‰æ¤œå‡ºãƒ»ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§MIDIæ›¸ãå‡ºã—ã«å¯¾å¿œã€‚  
  â†’ å…¬å¼ï¼š[[https://github.com/DamRsn/NeuralNote][github.com/DamRsn/NeuralNote]]
- ğŸ¼ *MuseScore*ï¼šç„¡æ–™ã®æ¥½è­œä½œæˆãƒ»è¡¨ç¤ºã‚½ãƒ•ãƒˆã€‚MusicXML ã‚„ MIDI ã®èª­ã¿è¾¼ã¿ã«å¯¾å¿œã—ã€æ­Œè©ç·¨é›†ã‚‚å¯èƒ½ã€‚  
  â†’ å…¬å¼ï¼š[[https://musescore.org/][musescore.org]]ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼š[[https://musescore.org/en/download][musescore.org/en/download]]ï¼‰

* ğŸŒ³ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆï¼ˆtreeï¼‰
#+begin_src text
project-root/
â”œâ”€â”€ README.org               # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆtangleå¯¾å¿œï¼‰
â”œâ”€â”€ Makefile                 # make run ã§å®Ÿè¡Œã§ãã‚‹
â”œâ”€â”€ process.sh               # éŸ³å£°â†’MIDI/SRT/MusicXML è‡ªå‹•å‡¦ç†
â”œâ”€â”€ full_music_pipeline.sh   # ã‚¹ãƒ†ãƒ åˆ†é›¢â†’NeuralNoteâ†’process.sh ã®çµ±åˆ
â”œâ”€â”€ requirements.txt         # Python ä¾å­˜ãƒªã‚¹ãƒˆ
â””â”€â”€ out/
    â”œâ”€â”€ stems/               # UVR5 å‡ºåŠ›ï¼ˆvocals / instrumentsï¼‰
    â”œâ”€â”€ midi/                # NeuralNote å‡ºåŠ›ï¼ˆpiano.mid / bass.mid / drums.midï¼‰
    â”œâ”€â”€ vocals_basic_pitch.mid
    â”œâ”€â”€ vocals.srt
    â””â”€â”€ vocals_with_lyrics.musicxml
#+end_src

* ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆåˆå›ã®ã¿ï¼‰
#+begin_src bash
# Homebrewï¼ˆmacOSï¼‰ãŒæœªå°å…¥ãªã‚‰å…ˆã«å…¥ã‚Œã‚‹
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

# å¿…è¦ãƒ„ãƒ¼ãƒ«
brew install ffmpeg

# Python ä»®æƒ³ç’°å¢ƒã®ä½œæˆã¨æœ‰åŠ¹åŒ–
python3 -m venv .venv
source .venv/bin/activate

# ä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä¸€æ‹¬ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install --upgrade pip setuptools wheel
pip install -r requirements.txt
#+end_src

* ğŸ“¦ requirements.txt :tangle requirements.txt
:PROPERTIES:
:header-args: :tangle requirements.txt :mkdirp yes
:END:
#+begin_src text
uvr5
basic-pitch
faster-whisper
music21
mido
srt
librosa
soundfile
numpy
scipy
tqdm
requests
torch
torchaudio
onnxruntime
#+end_src

* ğŸ” å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆMermaid ãƒ•ãƒ­ãƒ¼ãƒãƒ£ãƒ¼ãƒˆï¼šâ€»å›³ã¯ASCIIå®‰å…¨è¡¨è¨˜ï¼‰
#+begin_src mermaid
flowchart TD
    A["Audio Input File"] --> B["UVR5 Stem Separation"]
    B -->|vocals.wav| C1["Vocal Track"]
    B -->|piano/bass/drums.wav| C2["Instrumental Stems"]

    C2 --> D["NeuralNote: Audio -> MIDI (manual)"]
    D --> E["Instrument MIDIs (piano.mid, bass.mid, drums.mid)"]

    C1 --> F["process.sh: Auto Conversion"]
    F --> F1["Basic Pitch: Audio -> MIDI"]
    F --> F2["Faster-Whisper: Audio -> SRT (lyrics)"]
    F --> F3["music21: Merge MIDI + Lyrics -> MusicXML"]
    F3 --> G["Lyrics-embedded MusicXML"]
    F3 --> H["MuseScore 4 (optional open)"]

    E --> I["DAW Import"]
    G --> I
    I --> J["Full Arrangement (Score + MIDI Integration)"]
#+end_src

* ğŸ§© ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³ï¼ˆDFDï¼šâ€»å›³ã¯ASCIIå®‰å…¨è¡¨è¨˜ï¼‰
#+begin_src mermaid
flowchart LR
    subgraph Input
        A["Original Audio"]
    end

    subgraph Processing
        B["UVR5: Stem Separation"]
        C["NeuralNote: Instrument MIDI"]
        D["process.sh: MIDI + Lyrics + MusicXML"]
    end

    subgraph Output
        E1["Stems (vocals/instruments)"]
        E2["Instrument MIDIs"]
        E3["Vocal MIDI"]
        E4["Lyrics SRT"]
        E5["MusicXML (with lyrics)"]
        E6["MuseScore / DAW Project"]
    end

    A --> B
    B -->|stems| E1
    E1 -->|vocals.wav| D
    E1 -->|instruments| C
    C --> E2
    D -->|MIDI| E3
    D -->|SRT| E4
    D -->|XML| E5
    E2 --> E6
    E5 --> E6
#+end_src

* â–¶ï¸ å®Ÿè¡Œæ–¹æ³•
- ã¾ãšå®Ÿè¡Œæ¨©é™ã‚’ä»˜ä¸ï¼ˆåˆå›ã®ã¿ï¼‰â†’ *chmod +x process.sh full_music_pipeline.sh*
- ã‚ã¨ã¯ *make run* ã§ä¸€æ°—ã«å®Ÿè¡Œï¼ˆéŸ³æºâ†’è­œé¢â†’DAWçµ±åˆã®æµã‚Œã‚’æ”¯æ´ï¼‰

#+begin_src bash
chmod +x process.sh full_music_pipeline.sh
make run INPUT="my_song.wav" OUT="out"
#+end_src

* ğŸ›  ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: process.shï¼ˆtangle å¯¾å¿œ / çµµæ–‡å­—ã‚³ãƒ¡ãƒ³ãƒˆOKï¼‰
:PROPERTIES:
:header-args: :tangle process.sh :mkdirp yes
:END:
#+begin_src bash
#!/usr/bin/env bash
# ğŸ¤ éŸ³å£° â†’ ğŸ¹ MIDI â†’ ğŸ“ æ­Œè©(SRT) â†’ ğŸ¼ MusicXMLï¼ˆæ­Œè©é€£æºï¼‰ã‚’è‡ªå‹•å®Ÿè¡Œ
# 1) å…¥åŠ›éŸ³æºã‚’ 44.1kHz mono WAV ã«æ­£è¦åŒ–
# 2) Basic Pitch ã§ãƒ¡ãƒ­ãƒ‡ã‚£ MIDI åŒ–
# 3) Faster-Whisper ã§æ­Œè©SRTæŠ½å‡º
# 4) music21 ã§ MIDI ã¨æ­Œè©ã‚’çªåˆã—ã¦ MusicXML ç”Ÿæˆ
set -euo pipefail

AUDIO_IN=""
OUT_DIR=""
WHISPER_MODEL="medium"
LANG="ja"
OPEN_MSCORE="false"
VENV_DIR=".venv-process"
BASIC_PITCH_OUT_SUB="midi"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -i|--input) AUDIO_IN="$2"; shift 2 ;;
    -o|--out) OUT_DIR="$2"; shift 2 ;;
    --lang) LANG="$2"; shift 2 ;;
    --whisper-model) WHISPER_MODEL="$2"; shift 2 ;;
    --open-mscore) OPEN_MSCORE="true"; shift ;;
    *) echo "Usage: ./process.sh -i <audio> -o <out> [--lang ja] [--whisper-model medium] [--open-mscore]"; exit 1 ;;
  esac
done

[[ -z "$AUDIO_IN" || -z "$OUT_DIR" ]] && { echo "[ERR] Input and output required"; exit 1; }

mkdir -p "$OUT_DIR"
ABS_OUT="$(cd "$OUT_DIR" && pwd)"

# ğŸ venvï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ã« requirements ã‚’å°å…¥
if [[ ! -d "$VENV_DIR" ]]; then
  echo "[INFO] Creating Python venv â†’ $VENV_DIR"
  python3 -m venv "$VENV_DIR"
fi
# shellcheck disable=SC1090
source "$VENV_DIR/bin/activate"
pip install -q --upgrade pip setuptools wheel
pip install -q -r requirements.txt

# ğŸ”Š 44.1kHz mono ã«æ­£è¦åŒ–
BASENAME="$(basename "$AUDIO_IN")"
STEM="${BASENAME%.*}"
WORK_WAV="$ABS_OUT/${STEM}_44100mono.wav"
echo "[INFO] Convert â†’ 44.1kHz mono WAV: $WORK_WAV"
ffmpeg -y -i "$AUDIO_IN" -ac 1 -ar 44100 -vn "$WORK_WAV" >/dev/null 2>&1

# ğŸ¶ Basic Pitch ã§ MIDI ç”Ÿæˆ
MIDI_DIR="$ABS_OUT/$BASIC_PITCH_OUT_SUB"
mkdir -p "$MIDI_DIR"
echo "[INFO] Basic Pitch â†’ MIDI ..."
basic-pitch "$WORK_WAV" --output-dir "$MIDI_DIR" >/dev/null
MIDI_PATH="$(ls "$MIDI_DIR"/*_basic_pitch.mid | head -n 1)"
[[ -z "$MIDI_PATH" ]] && { echo "[ERR] MIDI output not found"; exit 1; }

# ğŸ—£ Faster-Whisper ã§ SRT ç”Ÿæˆ
ASR_DIR="$ABS_OUT/lyrics"
mkdir -p "$ASR_DIR"
echo "[INFO] Faster-Whisper â†’ SRT (lyrics) ..."
faster-whisper-transcribe --model "$WHISPER_MODEL" --language "$LANG" --task transcribe \
  --vad_filter True --output_format srt --output_dir "$ASR_DIR" "$WORK_WAV" >/dev/null 2>&1 || true
SRT_PATH="$(ls "$ASR_DIR"/*.srt | head -n 1)"
[[ -z "$SRT_PATH" ]] && { echo "[ERR] SRT not found"; exit 1; }

# ğŸ§© music21 ã§ MIDI + æ­Œè© â†’ MusicXML
XML_OUT="$ABS_OUT/${STEM}_with_lyrics.musicxml"
echo "[INFO] Build MusicXML â†’ $XML_OUT"
python3 - "$MIDI_PATH" "$SRT_PATH" "$XML_OUT" <<'PY'
import sys,re,srt
from music21 import converter,note
midi,srtf,xml=sys.argv[1:]
sc=converter.parse(midi)
# æœ€ã‚‚ãƒãƒ¼ãƒˆæ•°ã®å¤šã„ãƒ‘ãƒ¼ãƒˆï¼ãƒ¡ãƒ­ãƒ‡ã‚£ä»®å®š
melody=max(sc.parts,key=lambda p:len(p.recurse().getElementsByClass(note.Note)))
notes=list(melody.recurse().getElementsByClass(note.Note))
subs=list(srt.parse(open(srtf,encoding='utf-8').read()))
words=[]
for sub in subs:
  line=re.sub(r'\s+',' ',sub.content.strip())
  for w in line.split(' '):
    w=w.strip()
    if not w: continue
    syls=w.split('-')
    for i,s in enumerate(syls):
      if s: words.append(s if i==len(syls)-1 else s+'-')
for i,n in enumerate(notes):
  if i>=len(words): break
  n.lyric=words[i]
sc.write('musicxml',fp=xml)
PY

echo "[OK] Done ğŸ‰"
echo " - MIDI: $MIDI_PATH"
echo " - SRT : $SRT_PATH"
echo " - XML : $XML_OUT"

# ğŸ¼ MuseScore ã‚’è‡ªå‹•ã§é–‹ãï¼ˆä»»æ„ï¼‰
if [[ "$OPEN_MSCORE" == "true" ]]; then
  if [ -d "/Applications/MuseScore 4.app" ]; then
    open -a "MuseScore 4" "$XML_OUT" || true
  elif [ -d "/Applications/MuseScore.app" ]; then
    open -a "MuseScore" "$XML_OUT" || true
  else
    echo "[WARN] MuseScore ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§é–‹ã„ã¦ãã ã•ã„ â†’ $XML_OUT"
  fi
fi
#+end_src

* ğŸ§µ ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: full_music_pipeline.shï¼ˆtangle å¯¾å¿œ / çµµæ–‡å­—ã‚³ãƒ¡ãƒ³ãƒˆOKï¼‰
:PROPERTIES:
:header-args: :tangle full_music_pipeline.sh :mkdirp yes
:END:
#+begin_src bash
#!/usr/bin/env bash
# ğŸš ã‚¹ãƒ†ãƒ åˆ†é›¢(UVR5) â†’ ğŸ§  NeuralNote(æ‰‹å‹•) â†’ âš™ï¸ process.sh ã®çµ±åˆãƒ•ãƒ­ãƒ¼
set -euo pipefail

AUDIO_IN=""
OUT_DIR=""
LANG="ja"
WHISPER_MODEL="medium"

while [[ $# -gt 0 ]]; do
  case "$1" in
    -i|--input) AUDIO_IN="$2"; shift 2 ;;
    -o|--out) OUT_DIR="$2"; shift 2 ;;
    --lang) LANG="$2"; shift 2 ;;
    --model) WHISPER_MODEL="$2"; shift 2 ;;
    *) echo "Usage: ./full_music_pipeline.sh -i <audio> -o <out>"; exit 1 ;;
  esac
done

[[ -z "$AUDIO_IN" || -z "$OUT_DIR" ]] && { echo "[ERR] Missing input/output"; exit 1; }

ABS_OUT="$(cd "$OUT_DIR" && pwd)"
mkdir -p "$ABS_OUT"

echo "[STEP 1] UVR5 ã§ã‚¹ãƒ†ãƒ åˆ†é›¢ â†’ $ABS_OUT/stems"
python3 -m uvr5 --input "$AUDIO_IN" --output "$ABS_OUT/stems" \
  --model "MDX-Net_Inst_HQ_3,MDX-Net_Voc_FT,MDX-Net_Drums" >/dev/null 2>&1 || {
  echo "[WARN] UVR5 CLI not found or failed. Run manually if needed."
}

echo "[STEP 2] NeuralNote ã§æ¥½å™¨MIDIåŒ–ï¼ˆæ‰‹å‹•ï¼‰"
cat <<'MSG'
æ‰‹é †ï¼š
  1) NeuralNote(VST3/AU/Standalone) ã‚’èµ·å‹•
  2) stems ã®æ¥½å™¨ãƒˆãƒ©ãƒƒã‚¯ï¼ˆpiano/bass/drumsï¼‰ã‚’èª­ã¿è¾¼ã¿
  3) ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´å¾Œã€out/midi/ ã¸ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã§ .mid ã‚’å‡ºåŠ›
å®Œäº†ã—ãŸã‚‰ Enter ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„â€¦
MSG
read -r _

VOCAL_STEM="$(ls "$ABS_OUT/stems"/*voc* 2>/dev/null | head -n 1 || true)"
[[ -z "$VOCAL_STEM" ]] && VOCAL_STEM="$AUDIO_IN"

echo "[STEP 3] process.sh ã§ãƒœãƒ¼ã‚«ãƒ«ã‚’è­œé¢åŒ–ï¼ˆæ­Œè©é€£æºï¼‰"
./process.sh -i "$VOCAL_STEM" -o "$ABS_OUT" \
  --whisper-model "$WHISPER_MODEL" \
  --lang "$LANG" \
  --open-mscore

echo "âœ… å®Œäº†ï¼šçµæœã¯ $ABS_OUT ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ"
echo " - Stems : $ABS_OUT/stems"
echo " - MIDIs : $ABS_OUT/midi (NeuralNote)"
echo " - Vocal : $ABS_OUT/vocals_basic_pitch.mid"
echo " - Lyrics: $ABS_OUT/vocals.srt"
echo " - XML   : $ABS_OUT/vocals_with_lyrics.musicxml"
#+end_src

* ğŸ§° Makefileï¼ˆtangle å¯¾å¿œï¼‰
:PROPERTIES:
:header-args: :tangle Makefile :mkdirp yes
:END:
#+begin_src makefile
# ğŸ¯ make run ã§ãƒ•ãƒ«ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ
INPUT ?= song.wav
OUT ?= out

run:
	@echo "=== Running full pipeline ==="
	@./full_music_pipeline.sh -i "$(INPUT)" -o "$(OUT)" --lang ja --model medium
	@echo "=== Done. Output stored in $(OUT) ==="

clean:
	rm -rf .venv-process .venv out
#+end_src
